<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>Test cleaning links</title>

	<!-- Mock browser object so cleanLink can be loaded -->
	<script>
	var browser =
	{
		runtime:
		{
			getURL: url => ('https://cdn.rawgit.com/Cimbali/CleanLinks/master/addon/' + url.replace(/^\/+/, '')),
		},
		i18n:
		{
			getMessage: () => null
		},
		storage: {}
	}
	</script>
	<script src="https://cdn.rawgit.com/Cimbali/CleanLinks/master/tests/setup.js"></script>

	<!-- Embed the actual clean_link script -->
	<script src="https://cdn.rawgit.com/Cimbali/CleanLinks/master/addon/modules/common.js"></script>
	<script src="https://cdn.rawgit.com/Cimbali/CleanLinks/master/addon/modules/punycode.js"></script>
	<script src="https://cdn.rawgit.com/Cimbali/CleanLinks/master/addon/modules/publicsuffixlist.js"></script>
	<script src="https://cdn.rawgit.com/Cimbali/CleanLinks/master/addon/modules/rules.js"></script>
	<script src="https://cdn.rawgit.com/Cimbali/CleanLinks/master/addon/modules/cleanlink.js"></script>

	<!-- Inner workings of this page -->
	<script>
	function add_to_list(dirty, clean)
	{
		let l = document.querySelector('ul#clean_history');

		l.appendChild(document.createElement('li'));
		l.appendChild(document.createElement('li'));
		l.appendChild(document.createElement('li'));

		l.children[2].textContent = ' ';

		l.children[1].textContent = clean;
		l.children[1].className = 'cleaned'

		l.children[0].textContent = dirty;
	}

	function test_cleaning()
	{
		let link = document.querySelector('#paste_link input').value;
		if (link)
			Rules.loaded.then(() =>
			{
				add_to_list(link, clean_link(link));
				document.querySelector('#paste_link input').value = '';
			})
	}

	window.addEventListener('load', () =>
	{
		document.querySelector('#paste_link button').addEventListener('click', test_cleaning);
		document.querySelector('#paste_link input').addEventListener('keyup', e =>
		{
			if (e.key === 'Enter')
			{
				e.stopPropagation();
				e.preventDefault();
				test_cleaning();
			}
		});

		fetch(browser.runtime.getURL('manifest.json')).then(async json =>
		{
			const manifest = JSON.parse(await json.text());
			const h1 = document.getElementsByTagName('h1')[0];
			h1.textContent = manifest.name + ' v' + manifest.version;
		});

	});
	</script>

	<!-- Styling for the page -->
	<style>
	p#paste_link {
		width: 100%;
		display: inline-flex;
		align-items: baseline;
	}
	p#paste_link input {
		width: 5em;
		margin: 0 1em;
		flex-grow: 1;
	}
	ul#clean_history {
		list-style: none;
	}
	ul#clean_history li.cleaned:before{
		content: '→';
		position: relative;
		left: -5px;
		padding-bottom: 10px;
	}
	</style>
</head>

<body>
	<h1></h1>
	<p>Test default rules of Clean Links.</p>
	<p id="paste_link">Link:&nbsp;<input type="text" />&nbsp;<button>Clean it!</button></p>
	<ul id="clean_history"></ul>
</body>

</html>
